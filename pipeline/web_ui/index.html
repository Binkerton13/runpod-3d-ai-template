<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Character Pipeline - Project Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üé¨ 3D Character Pipeline</h1>
                <div class="project-selector">
                    <select id="projectSelect" onchange="loadProject(this.value)">
                        <option value="">Select Project...</option>
                    </select>
                    <button class="btn btn-primary" onclick="showNewProjectDialog()">+ New Project</button>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
                        <span id="themeIcon">üåô</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - File Upload -->
            <div class="sidebar sidebar-left">
                <h2>üìÇ Input Files</h2>
                
                <!-- Character Mesh Upload -->
                <div class="upload-section">
                    <h3>Character Mesh</h3>
                    <div class="drop-zone" id="meshDropZone" 
                         ondrop="handleDrop(event, 'mesh')" 
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üì¶</span>
                            <p>Drop FBX/OBJ file here</p>
                            <input type="file" id="meshInput" accept=".fbx,.obj" onchange="handleFileSelect(event, 'mesh')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('meshInput').click()">Browse</button>
                        </div>
                        <div class="file-info" id="meshInfo" style="display: none"></div>
                    </div>
                    <div class="form-group" id="meshTypeGroup" style="display: none; margin-top: 1rem;">
                        <label for="meshTypeSelect">Mesh Type</label>
                        <select id="meshTypeSelect" onchange="updateMeshType(this.value)">
                            <option value="skeletal">Skeletal (Rigging + Animation)</option>
                            <option value="static">Static (Texture Only)</option>
                        </select>
                        <small>Static meshes skip rigging and animation steps</small>
                    </div>
                </div>

                <!-- UDIM Tiles Upload -->
                <div class="upload-section">
                    <h3>UDIM Tiles</h3>
                    <div class="drop-zone" id="udimDropZone"
                         ondrop="handleDrop(event, 'udim')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üñºÔ∏è</span>
                            <p>Drop UDIM PNG files here</p>
                            <input type="file" id="udimInput" accept=".png" multiple onchange="handleFileSelect(event, 'udim')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('udimInput').click()">Browse</button>
                        </div>
                        <div id="udimList" class="file-list"></div>
                    </div>
                </div>

                <!-- Style References -->
                <div class="upload-section">
                    <h3>Style References</h3>
                    <div class="drop-zone" id="styleRefDropZone"
                         ondrop="handleDrop(event, 'style_reference')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üé®</span>
                            <p>Style/texture references</p>
                            <input type="file" id="styleRefInput" accept="image/*" multiple onchange="handleFileSelect(event, 'style_reference')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('styleRefInput').click()">Browse</button>
                        </div>
                        <div id="styleRefList" class="file-list"></div>
                    </div>
                </div>

                <!-- Pose/Motion References -->
                <div class="upload-section">
                    <h3>Pose References</h3>
                    <div class="drop-zone" id="poseRefDropZone"
                         ondrop="handleDrop(event, 'pose_reference')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üßò</span>
                            <p>Motion/pose references</p>
                            <input type="file" id="poseRefInput" accept="image/*" multiple onchange="handleFileSelect(event, 'pose_reference')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('poseRefInput').click()">Browse</button>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Tip: Use OpenPose, DWPose, or depth maps for best results</small>
                        <div id="poseRefList" class="file-list"></div>
                    </div>
                </div>

                <!-- ComfyUI Models Management -->
                <div class="upload-section">
                    <h3>ü§ñ ComfyUI Models</h3>
                    <button class="btn btn-small" onclick="toggleModelManager()" style="width: 100%; margin-bottom: 0.5rem;">
                        üì¶ Manage Models
                    </button>
                    <div id="modelValidation" class="model-validation" style="display: none;">
                        <div class="validation-item" id="textureValidation">
                            <span class="validation-icon">‚è≥</span>
                            <span>Texture Workflow</span>
                        </div>
                        <div class="validation-item" id="spriteValidation">
                            <span class="validation-icon">‚è≥</span>
                            <span>Sprite Workflow</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Uploading...</p>
                </div>
            </div>

            <!-- Center - 3D Viewer -->
            <div class="viewer-container">
                <div class="viewer-header">
                    <h2 id="viewerTitle">üé® Model Viewer</h2>
                    <div class="viewer-controls">
                        <select id="imageTypeSelector" style="display: none;" onchange="switchImageType(this.value)">
                            <option value="udim">UDIM Tiles</option>
                            <option value="style">Style References</option>
                            <option value="pose">Pose References</option>
                            <option value="textures">Generated Textures</option>
                        </select>
                        <button class="btn btn-small" id="viewModeToggle" onclick="toggleViewMode()">üñºÔ∏è Image View</button>
                        <button class="btn btn-small" id="materialViewBtn" onclick="toggleMaterialView()" style="display: none;">üé® Material View</button>
                        <button class="btn btn-small" id="resetViewBtn" onclick="resetCamera()">‚Üª Reset View</button>
                        <button class="btn btn-small" id="wireframeBtn" onclick="toggleWireframe()">‚¨ö Wireframe</button>
                        <button class="btn btn-small" id="gridBtn" onclick="toggleGrid()">‚äû Grid</button>
                    </div>
                </div>
                <div id="viewer3d" class="viewer-canvas">
                    <div class="animation-controls" id="animControls" style="display: none;">
                        <button class="anim-btn" id="playPauseBtn" onclick="toggleAnimation()">‚ñ∂Ô∏è</button>
                        <input type="range" id="animSlider" min="0" max="100" value="0" oninput="seekAnimation(this.value)">
                        <span id="animTime">0:00 / 0:00</span>
                    </div>
                </div>
                <div id="imageViewer" class="viewer-canvas" style="display: none;">
                    <div class="image-viewer-content">
                        <div id="imageViewerGrid" class="image-grid"></div>
                        <div id="imageViewerSingle" class="image-single" style="display: none;">
                            <img id="imageViewerImg" src="" alt="Preview">
                        </div>
                    </div>
                </div>
                <div class="viewer-info">
                    <span id="vertexCount">Vertices: -</span>
                    <span id="faceCount">Faces: -</span>
                    <span id="meshFormat">Format: -</span>
                    <span id="imageCount" style="display: none;">Images: -</span>
                </div>
            </div>

            <!-- Right Sidebar - Configuration -->
            <div class="sidebar sidebar-right">
                <h2>‚öôÔ∏è Configuration</h2>
                
                <!-- Project Settings -->
                <div class="config-section">
                    <h3>Project Settings</h3>
                    <div class="form-group">
                        <label for="projectNameInput">Project Name</label>
                        <input type="text" id="projectNameInput" placeholder="MyCharacter" disabled>
                    </div>
                </div>

                <!-- Texture Prompts -->
                 <!-- IAW prompt_lbrary.json -->
                <div class="config-section">
                    <h3>Texture Generation</h3>
                    <div class="form-group">
                        <label for="texturePrompt">Positive Prompt</label>
                        <textarea id="texturePrompt" rows="3" placeholder="skin texture, realistic pores, high detail"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="textureNegative">Negative Prompt</label>
                        <textarea id="textureNegative" rows="2" placeholder="distortion, artifacts, blur"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="textureSeed">Seed</label>
                        <input type="number" id="textureSeed" value="12345">
                    </div>
                </div>

                <!-- Rig Settings -->
                <div class="config-section">
                    <h3>Rigging</h3>
                    <div class="form-group">
                        <label for="rigPreset">Preset</label>
                        <select id="rigPreset">
                            <option value="humanoid_standard">Humanoid Standard</option>
                            <option value="humanoid_game">Humanoid Game</option>
                            <option value="creature">Creature</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rigScale">Scale</label>
                        <input type="number" id="rigScale" value="1.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="rigOrientation">Orientation</label>
                        <select id="rigOrientation">
                            <option value="Y_UP">Y-Up</option>
                            <option value="Z_UP">Z-Up</option>
                        </select>
                    </div>
                </div>

                <!-- Animation Settings -->
                <div class="config-section">
                    <h3>Animation</h3>
                    
                    <!-- Prompt Library Selector -->
                    <div class="form-group">
                        <label for="promptCategory">Category</label>
                        <select id="promptCategory" onchange="loadPromptCategory(this.value)">
                            <option value="">Select category...</option>
                            <option value="locomotion">Locomotion</option>
                            <option value="idle">Idle</option>
                            <option value="combat">Combat</option>
                            <option value="gestures">Gestures</option>
                            <option value="cinematic">Cinematic</option>
                            <option value="transitions">Transitions</option>
                            <option value="stylized">Stylized</option>
                            <option value="traversal">Traversal</option>
                            <option value="special">Special</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="promptSelectGroup" style="display: none;">
                        <label for="promptSelect">Preset</label>
                        <select id="promptSelect" onchange="loadPromptPreset(this.value)">
                            <option value="">Select preset...</option>
                        </select>
                    </div>
                    
                    <!-- Motion Prompt Fields -->
                    <div class="form-group">
                        <label for="motionField">Motion</label>
                        <textarea id="motionField" rows="3" placeholder="Describe the primary motion and mechanics"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="styleField">Style</label>
                        <textarea id="styleField" rows="2" placeholder="Animation style and characteristics"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="constraintsField">Constraints</label>
                        <textarea id="constraintsField" rows="2" placeholder="Technical constraints and requirements"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="cameraField">Camera</label>
                        <input type="text" id="cameraField" value="Locked." placeholder="Camera behavior">
                    </div>
                    
                    <div class="form-group">
                        <label for="outputField">Output</label>
                        <input type="text" id="outputField" value="30 frames, 30fps." placeholder="Duration and frame rate">
                    </div>
                </div>

                <!-- Sprite Generation -->
                <div class="config-section" id="spriteSection">
                    <h3>2D Sprite Generation</h3>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSprites" onchange="toggleSpriteOptions(this.checked)">
                            Enable sprite generation from animation
                        </label>
                    </div>
                    
                    <div id="spriteOptions" style="display: none;">
                        <div class="form-group">
                            <label for="spriteFrameInterval">Frame Interval</label>
                            <select id="spriteFrameInterval">
                                <option value="1">Every Frame (30fps)</option>
                                <option value="2" selected>Every 2nd Frame (15fps)</option>
                                <option value="3">Every 3rd Frame (10fps)</option>
                                <option value="4">Every 4th Frame (7.5fps)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="spriteAngles">Camera Angles</label>
                            <select id="spriteAngles" multiple size="4">
                                <option value="front" selected>Front (0¬∞)</option>
                                <option value="side" selected>Side (90¬∞)</option>
                                <option value="back">Back (180¬∞)</option>
                                <option value="diagonal" selected>Diagonal (45¬∞)</option>
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="spriteCharacterPrompt">Character Overlay Prompt</label>
                            <textarea id="spriteCharacterPrompt" rows="3" placeholder="female character, green hair, ponytail, fantasy armor"></textarea>
                            <small>3D model used as reference + these modifications</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="spriteNegativePrompt">Negative Prompt</label>
                            <textarea id="spriteNegativePrompt" rows="2" placeholder="low quality, blurry, distorted"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="spriteResolution">Sprite Resolution</label>
                            <select id="spriteResolution">
                                <option value="512">512x512</option>
                                <option value="768" selected>768x768</option>
                                <option value="1024">1024x1024</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="spriteSpritesheet" checked>
                                Generate spritesheets (combined frames)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="config-section">
                    <h3>References</h3>
                    <div class="reference-summary">
                        <div class="ref-count">
                            <span id="styleRefCount">Style: 0</span>
                            <span id="poseRefCount">Pose: 0</span>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Use Image View dropdown to preview references</small>
                    </div>
                </div>

                <!-- Export Settings -->
                <div class="config-section">
                    <h3>Export</h3>
                    <div class="form-group">
                        <label for="exportFormat">Format</label>
                        <select id="exportFormat">
                            <option value="fbx">FBX</option>
                            <option value="obj">OBJ</option>
                            <option value="glb">GLB</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exportPackage" checked>
                            Create package archive
                        </label>
                    </div>
                </div>

                <!-- Pipeline Execution -->
                <div class="config-section">
                    <h3>Pipeline Execution</h3>
                    <button class="btn btn-primary btn-large" onclick="runPipeline()" id="runPipelineBtn">
                        ‚ñ∂Ô∏è Run Pipeline
                    </button>
                    <button class="btn btn-small" onclick="refreshPipelineStatus()" style="margin-top: 0.5rem;">
                        üîÑ Refresh Status
                    </button>
                    
                    <div id="pipelineStatus" class="pipeline-status" style="margin-top: 1rem; display: none;">
                        <h4>Pipeline Status</h4>
                        <div id="pipelineStages"></div>
                        <div class="pipeline-log" id="pipelineLog" style="display: none;">
                            <h5>Recent Log <button class="btn-link" onclick="togglePipelineLog()">Toggle</button></h5>
                            <pre id="logContent"></pre>
                        </div>
                    </div>
                </div>

                <!-- Save Configuration -->
                <div class="config-section">
                    <h3>Export Formats</h3>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="exportFBX" checked> FBX</label>
                        <label><input type="checkbox" id="exportGLTF" checked> glTF</label>
                        <label><input type="checkbox" id="exportUSD"> USD</label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-secondary btn-block" onclick="saveConfig()">üíæ Save Config</button>
                    <button class="btn btn-success btn-block" onclick="startPipeline()">‚ñ∂Ô∏è Run Pipeline</button>
                </div>
            </div>
        </div>

        <!-- Pipeline Status Footer -->
        <footer class="status-bar" id="statusBar">
            <div class="status-content">
                <span id="statusText">Ready</span>
                <div class="status-indicators">
                    <span class="indicator" id="comfyStatus">ComfyUI: <span class="status-dot"></span></span>
                    <span class="indicator" id="pipelineStatus">Pipeline: <span class="status-dot"></span></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2>Create New Project</h2>
            <div class="form-group">
                <label for="newProjectName">Project Name</label>
                <input type="text" id="newProjectName" placeholder="MyCharacter" autofocus>
                <small>Alphanumeric, underscores, and hyphens only</small>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">Create</button>
            </div>
        </div>
    </div>

    <!-- Pipeline Progress Modal -->
    <div id="pipelineModal" class="modal">
        <div class="modal-content modal-large">
            <h2>Pipeline Progress</h2>
            <div id="pipelineSteps"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closePipelineModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Model Manager Modal -->
    <div id="modelManagerModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ü§ñ ComfyUI Model Manager</h2>
                <button class="btn btn-secondary" onclick="closeModelManager()">‚úï</button>
            </div>
            
            <div class="model-manager-tabs">
                <button class="tab-btn active" onclick="switchModelTab('browse')">üìã Browse</button>
                <button class="tab-btn" onclick="switchModelTab('upload')">‚¨ÜÔ∏è Upload</button>
                <button class="tab-btn" onclick="switchModelTab('select')">‚öôÔ∏è Select Models</button>
            </div>
            
            <!-- Browse Tab -->
            <div id="browseTab" class="tab-content active">
                <div class="model-type-selector">
                    <label>Model Type:</label>
                    <select id="browseModelType" onchange="loadModelsForType(this.value)">
                        <option value="checkpoints">Checkpoints</option>
                        <option value="loras">LoRAs</option>
                        <option value="controlnet">ControlNet</option>
                        <option value="vae">VAE</option>
                        <option value="ipadapter">IP-Adapter</option>
                        <option value="embeddings">Embeddings</option>
                        <option value="upscale_models">Upscale Models</option>
                        <option value="clip_vision">CLIP Vision</option>
                    </select>
                    <button class="btn btn-small" onclick="refreshModelList()">üîÑ Refresh</button>
                </div>
                
                <div id="modelList" class="model-list">
                    <div class="loading">Loading models...</div>
                </div>
            </div>
            
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content">
                <div class="upload-form">
                    <div class="form-group">
                        <label for="uploadModelType">Model Type</label>
                        <select id="uploadModelType">
                            <option value="checkpoints">Checkpoint (.safetensors, .ckpt)</option>
                            <option value="loras">LoRA (.safetensors, .ckpt)</option>
                            <option value="controlnet">ControlNet (.safetensors, .pth)</option>
                            <option value="vae">VAE (.safetensors, .pt)</option>
                            <option value="ipadapter">IP-Adapter (.safetensors, .bin)</option>
                            <option value="embeddings">Embedding (.safetensors, .pt)</option>
                            <option value="upscale_models">Upscale Model (.pth)</option>
                            <option value="clip_vision">CLIP Vision (.safetensors)</option>
                        </select>
                    </div>
                    
                    <div class="drop-zone" id="modelDropZone" 
                         ondrop="handleModelDrop(event)" 
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üì¶</span>
                            <p>Drop model file here</p>
                            <input type="file" id="modelFileInput" accept=".safetensors,.ckpt,.pt,.pth,.bin" onchange="handleModelFileSelect(event)" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('modelFileInput').click()">Browse</button>
                        </div>
                    </div>
                    
                    <div id="modelUploadProgress" style="display: none; margin-top: 1rem;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="modelProgressFill"></div>
                        </div>
                        <p id="modelProgressText">Uploading...</p>
                    </div>
                    
                    <div class="model-info-panel">
                        <h4>üìù Model Guidelines</h4>
                        <ul>
                            <li><strong>Checkpoints:</strong> Base models (SDXL, SD 1.5, etc.)</li>
                            <li><strong>LoRAs:</strong> Style and character refinements</li>
                            <li><strong>ControlNet:</strong> Pose, depth, and structural control</li>
                            <li><strong>IP-Adapter:</strong> Image-based style transfer</li>
                        </ul>
                        <p><small>‚ö†Ô∏è Large files may take several minutes to upload</small></p>
                    </div>
                </div>
            </div>
            
            <!-- Select Models Tab -->
            <div id="selectTab" class="tab-content">
                <div class="workflow-selector">
                    <label>Workflow:</label>
                    <select id="workflowSelect" onchange="loadWorkflowModels(this.value)">
                        <option value="texture_workflow">Texture Generation</option>
                        <option value="sprite_generation_workflow">Sprite Generation</option>
                    </select>
                </div>
                
                <div id="workflowValidation" class="workflow-validation"></div>
                
                <div id="modelSelectors" class="model-selectors">
                    <!-- Dynamically populated -->
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="autoSelectWorkflowModels()">üîÑ Auto-Select</button>
                    <button class="btn btn-primary" onclick="saveWorkflowModelSelections()">üíæ Save Selections</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
